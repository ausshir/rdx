<!DOCTYPE html><html><head>
    <title>Inbox - rdx for reddit </title>
    <meta name="description" content="Inbox of rdx for Reddit."/>
    <link rel="shortcut icon" href="favicon.ico"> 
  <link rel="icon" href="favicon.png">
      <link rel="manifest" href="/manifest.json" />
 <meta name="apple-mobile-web-app-capable" content="yes" />
 <meta name="robots" content="noindex,nofollow"/>
    <meta name="apple-mobile-web-app-title" content="rdx" />
    <meta   name="apple-mobile-web-app-status-bar-style" content="default" />
     <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta charset="utf-8">
    <link rel="stylesheet" href="styles.css" type="text/css">
    <style>#body {
    padding: 15px;
}
b,li{display:block;padding:5px;margin:5px;}




</style>
</head>   
<body>
    <header id="header">
        <div id="pagetitle">
            <span id="pagetitletext">Inbox</span>
        </div>
    </header>
    <div id="body">
    <div id="inboxbody">
 
</div>
<input id="actype" type="hidden" value="i"/>

</div>
    <script>

if(localStorage.getItem('color') == 'dark'){
toggletheme('dark');
}
else {}

function toggletheme(color){
if(color == 'dark'){
document.documentElement.style.setProperty('--bodyc', '#111222');
document.documentElement.style.setProperty('--textc', 'white');
document.documentElement.style.setProperty('--linkc', '#d9d983');
document.documentElement.style.setProperty('--greyc', '#222233');
document.documentElement.style.setProperty('--lightc', '#ddd');
}}
 
 function inboxto(){
    document.getElementById('actype').value = "i";
        apiAction();
}

function apiAction() {
    const accessToken = localStorage.getItem('accessToken');
    const expiresIn = localStorage.getItem('expiresIn');
    const refreshToken = localStorage.getItem('refreshToken');
    const clientId = localStorage.getItem('clientId');
    const clientSecret = localStorage.getItem('clientSecret');
    const redirectUri = 'https://rdx.overdevs.com/login.html'; 
    const actionType  = document.getElementById('actype').value;
 
  
    if (accessToken && expiresIn) {
        const currentTimestamp = Date.now();
        const expiresAt = parseInt(expiresIn);
        if (currentTimestamp < expiresAt) {
        if(actionType == "c") {
            submitComment(accessToken);
           }
           else if(actionType == "e") {
           	editComment(accessToken);
           }
           else if(actionType == "d") {
           	delComment(accessToken);
           }
              else if(actionType == "i") {
           	getInbox(accessToken);
           }
           else {}
        } else {
            // Access token has expired, renew it using refreshToken
            fetch(tokenUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': `Basic ${btoa(`${clientId}:${clientSecret}`)}`,
                },
                body: `grant_type=refresh_token&refresh_token=${refreshToken}`,
            })
            .then(response => response.json())
            .then(tokenData => {
                const newAccessToken = tokenData.access_token;
                const newRefreshToken = tokenData.refresh_token;
                const expiresIn = tokenData.expires_in; // Expires in seconds
                const expirationTimestamp = currentTimestamp + (expiresIn * 1000);
                localStorage.setItem('accessToken', newAccessToken);
                localStorage.setItem('refreshToken', newRefreshToken);
                localStorage.setItem('expiresIn', expirationTimestamp.toString());
                  if(actionType == "c") {
            submitComment(accessToken);
           }
           else if(actionType == "e") {
           	editComment(accessToken);
           }
           else if(actionType == "d") {
           	delComment(accessToken);
           }
            else if(actionType == "i") {
           	getInbox(accessToken);
           }
           else {}
            })
            .catch(error => {
            	    document.getElementById('cmntbtn').disabled = false;
    document.getElementById('cmntbtn').innerHTML = 'Submit';
                alert('Error refreshing token:', error);
            });
        }
    } else {
        window.location.href = 'login.html';
    }
}


  function getInbox(accessToken) {
const inboxUrl = 'https://oauth.reddit.com/message/inbox';

fetch(inboxUrl, {
    method: 'GET',
    headers: {
        'Authorization': `Bearer ${accessToken}`
    },
})
.then(response => response.json())
.then(inboxData => {
    if (inboxData.error) {
        console.error('Error fetching inbox messages:', inboxData.error);
    } else {
        const inboxMessages = inboxData.data.children;
console.log(inboxMessages);
      
    let html = '';

  inboxMessages.forEach((item) => {
    const { kind, inboxMessages: { author, created_utc, subject, link_title, body_html, tname, context } } = item;
    const date = new Date(created_utc * 1000);
    const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()} - ${date.getHours()}:${date.getMinutes()}`;

    if (kind === 't1') {
      html += `<div class="inboxmsgwrap"><div class="ibxmeta"><span class="ibxauthor"><a href="user.html?u=${author}">u/${author}</a> &bull;  <span class="ibxtime">${formattedDate}</span></span></div>`;
      html += `<div class="ibxsub">${subject}</div>`;
      html += `<div class="ibxlink"><a href="comments.html?url=https://www.reddit.com${context}">${link_title}</a></div>`;
      html += `<div class="ibxmsg">${body_html}</div>`;
      html += `<div class="ibxactions"><button onclick="replyto('${tname}')">Reply</button></div></div>`;
    } else if (kind === 't4') {
      html += `<div class="inboxmsgwrap"><div class="ibxmeta"><span class="ibxauthor"><a href="user.html?u=${author}">u/${author}</a> &bull;  <span class="ibxtime">${formattedDate}</span></span></div>`;
      html += `<div class="ibxsub">${subject}</div>`;
      html += `<div class="ibxmsg">${body_html}</div></div>`;
      html += `<div class="ibxactions"><button onclick="replyto('${tname}')">Reply</button></div></div>`;

    }
  });
document.getElementById('inboxbody').innerHTML = html;
    }
})
.catch(error => {
    console.error('Error fetching inbox messages:', error);
});

}
  inboxto();
    </script>
    </body></html>